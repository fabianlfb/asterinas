# .github/workflows/rerun-failed-workflow.yml
name: Rerun Failed Workflow

on:
  issue_comment:
    types: [created]

jobs:
  rerun-workflow:
    runs-on: ubuntu-latest
    steps:
      - name: Check if comment contains rerun command and is from a pull request
        id: check_comment
        run: |
          echo "COMMENT_BODY=${{ github.event.comment.body }}" >> $GITHUB_ENV
          if [[ "${{ github.event.comment.body }}" == "/rerun" && "${{ github.event.issue.pull_request }}" ]]; then
            echo "RERUN_COMMAND=true" >> $GITHUB_ENV
          fi
          
      - name: Get pull request owner
        if: env.RERUN_COMMAND == 'true'
        id: get_pr_owner
        run: |
          PR_NUMBER=$(echo ${{ github.event.issue.number }})
          PR_OWNER=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER" | \
            jq -r '.user.login')
          echo "PR_OWNER=$PR_OWNER" >> $GITHUB_ENV
          
      - name: Check if comment author is pull request owner
        if: env.RERUN_COMMAND == 'true'
        id: check_author
        run: |
          COMMENT_AUTHOR=$(echo ${{ github.event.comment.user.login }})
          if [[ "$COMMENT_AUTHOR" == "$PR_OWNER" ]]; then
            echo "AUTHOR_IS_OWNER=true" >> $GITHUB_ENV
          fi
          
      - name: Rerun failed jobs
        if: env.RERUN_COMMAND == 'true' && env.AUTHOR_IS_OWNER == 'true'
        run: |
          # Get the workflow run ID of the last failed run
          WORKFLOW_RUN_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs" | \
            jq '.workflow_runs[] | select(.status == "completed" and .conclusion == "failure") | .id' | head -n 1)
          
          # Get the jobs of the failed workflow run
          JOBS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/$WORKFLOW_RUN_ID/jobs")
          
          # Find the failed job IDs
          FAILED_JOB_IDS=$(echo $JOBS | jq -r '.jobs[] | select(.conclusion == "failure") | .id')
          
          # Rerun each failed job
          for JOB_ID in $FAILED_JOB_IDS; do
            curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/actions/jobs/$JOB_ID/rerun"
          done
          